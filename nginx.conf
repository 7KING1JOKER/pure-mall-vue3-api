events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 设置默认字符集为UTF-8
    charset utf-8;

    server {
        listen 80;
        server_name _;  # 使用通配符匹配所有域名和IP地址
        
        # 重定向HTTP到HTTPS
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name _;  # 使用通配符匹配所有域名和IP地址

        # SSL证书配置（使用自签名证书或购买的证书）
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        # SSL相关配置
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;

        # 移除Nginx层面的CORS配置，由后端Spring Boot统一管理
        location / {
            # 移除OPTIONS请求的直接处理，让请求到达后端由Spring Boot处理
            # 这样后端可以正确返回所有CORS头
            # 使用变量形式的proxy_pass，使Nginx在请求时才解析主机名
            set $backend_url http://backend:8080;
            proxy_pass $backend_url;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 添加重试机制和动态解析
            resolver 127.0.0.11 valid=30s;  # Docker内置DNS服务器
            proxy_connect_timeout 5s;
            proxy_send_timeout 5s;
            proxy_read_timeout 5s;
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        # 静态资源缓存配置
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf)$ {
            # 使用变量形式的proxy_pass，使Nginx在请求时才解析主机名
            set $backend_url http://backend:8080;
            proxy_pass $backend_url;
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }
    }
}